<template>
  <div
    style="width: 270px; height: auto; background-color: #fff"
    class="relative ml-7 mt-14 border rounded-lg mb-6"
  >
    <!-- thời gian chạy -->
    <div
      class="flex justify-center items-center w-full h-14 rounded-t-lg bg-[#D2E8E0]"
    >
      <div class="">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="40"
          height="40"
          viewBox="0 0 40 40"
          fill="none"
        >
          <path
            d="M28.75 0.9375H22.5C21.9822 0.9375 21.5625 1.35723 21.5625 1.875V3.75C21.5625 4.26777 21.9822 4.6875 22.5 4.6875H28.75C29.2678 4.6875 29.6875 4.26777 29.6875 3.75V1.875C29.6875 1.35723 29.2678 0.9375 28.75 0.9375Z"
            fill="#1D8C64"
          />
          <path
            d="M10.625 14.6875H4.375C4.12636 14.6875 3.8879 14.7863 3.71209 14.9621C3.53627 15.1379 3.4375 15.3764 3.4375 15.625C3.4375 15.8736 3.53627 16.1121 3.71209 16.2879C3.8879 16.4637 4.12636 16.5625 4.375 16.5625H10.625C10.8736 16.5625 11.1121 16.4637 11.2879 16.2879C11.4637 16.1121 11.5625 15.8736 11.5625 15.625C11.5625 15.3764 11.4637 15.1379 11.2879 14.9621C11.1121 14.7863 10.8736 14.6875 10.625 14.6875Z"
            fill="#1D8C64"
          />
          <path
            d="M10.3125 23.125C10.3125 22.8764 10.2137 22.6379 10.0379 22.4621C9.8621 22.2863 9.62364 22.1875 9.375 22.1875H3.125C2.87636 22.1875 2.6379 22.2863 2.46209 22.4621C2.28627 22.6379 2.1875 22.8764 2.1875 23.125C2.1875 23.3736 2.28627 23.6121 2.46209 23.7879C2.6379 23.9637 2.87636 24.0625 3.125 24.0625H9.375C9.62364 24.0625 9.8621 23.9637 10.0379 23.7879C10.2137 23.6121 10.3125 23.3736 10.3125 23.125Z"
            fill="#1D8C64"
          />
          <path
            d="M10 25.9375H5.625C5.37636 25.9375 5.1379 26.0363 4.96209 26.2121C4.78627 26.3879 4.6875 26.6264 4.6875 26.875C4.6875 27.1236 4.78627 27.3621 4.96209 27.5379C5.1379 27.7137 5.37636 27.8125 5.625 27.8125H10C10.2486 27.8125 10.4871 27.7137 10.6629 27.5379C10.8387 27.3621 10.9375 27.1236 10.9375 26.875C10.9375 26.6264 10.8387 26.3879 10.6629 26.2121C10.4871 26.0363 10.2486 25.9375 10 25.9375Z"
            fill="#1D8C64"
          />
          <path
            d="M10.3125 19.375C10.3125 19.1264 10.2137 18.8879 10.0379 18.7121C9.8621 18.5363 9.62364 18.4375 9.375 18.4375H1.25C1.00136 18.4375 0.762903 18.5363 0.587087 18.7121C0.411272 18.8879 0.3125 19.1264 0.3125 19.375C0.3125 19.6236 0.411272 19.8621 0.587087 20.0379C0.762903 20.2137 1.00136 20.3125 1.25 20.3125H9.375C9.62364 20.3125 9.8621 20.2137 10.0379 20.0379C10.2137 19.8621 10.3125 19.6236 10.3125 19.375Z"
            fill="#1D8C64"
          />
          <path
            d="M25.625 21.25V10.625C19.7663 10.625 15 15.3913 15 21.25C15 27.1087 19.7663 31.875 25.625 31.875C31.4837 31.875 36.25 27.1087 36.25 21.25H25.625Z"
            fill="#1D8C64"
          />
          <path
            d="M35.9077 11.6682L36.9129 10.6629C37.0011 10.5761 37.0713 10.4727 37.1193 10.3587C37.1674 10.2446 37.1924 10.1222 37.1929 9.99842C37.1934 9.87466 37.1694 9.75203 37.1223 9.6376C37.0751 9.52317 37.0058 9.4192 36.9183 9.33169C36.8308 9.24418 36.7268 9.17486 36.6124 9.12774C36.498 9.08061 36.3753 9.05661 36.2516 9.05711C36.1278 9.05761 36.0054 9.08261 35.8914 9.13067C35.7773 9.17873 35.6739 9.24889 35.5871 9.33711L34.5409 10.3833C32.526 8.72346 30.0873 7.65985 27.5 7.3125V5.625H23.75V7.3125C21.1628 7.65972 18.7241 8.72316 16.7091 10.3828L15.6629 9.33664C15.5761 9.24842 15.4727 9.17826 15.3587 9.1302C15.2446 9.08215 15.1222 9.05714 14.9984 9.05664C14.8747 9.05614 14.752 9.08014 14.6376 9.12727C14.5232 9.17439 14.4192 9.24371 14.3317 9.33122C14.2442 9.41873 14.1749 9.5227 14.1277 9.63713C14.0806 9.75156 14.0566 9.87419 14.0571 9.99795C14.0576 10.1217 14.0826 10.2441 14.1307 10.3582C14.1787 10.4722 14.2489 10.5756 14.3371 10.6624L15.3423 11.6677C12.9113 14.2659 11.5599 17.6918 11.5625 21.25C11.5625 29.0041 17.8709 35.3125 25.625 35.3125C33.3791 35.3125 39.6875 29.0041 39.6875 21.25C39.69 17.692 38.3386 14.2663 35.9077 11.6682ZM25.625 32.8125C23.3382 32.8125 21.1027 32.1344 19.2012 30.8639C17.2998 29.5934 15.8178 27.7875 14.9426 25.6748C14.0675 23.562 13.8385 21.2372 14.2847 18.9943C14.7308 16.7514 15.832 14.6911 17.4491 13.0741C19.0661 11.457 21.1264 10.3558 23.3693 9.90967C25.6122 9.46353 27.937 9.6925 30.0498 10.5676C32.1626 11.4428 33.9684 12.9248 35.2389 14.8262C36.5094 16.7277 37.1875 18.9632 37.1875 21.25C37.1875 22.7684 36.8884 24.2719 36.3074 25.6748C35.7263 27.0776 34.8746 28.3522 33.8009 29.4259C32.7272 30.4996 31.4526 31.3513 30.0498 31.9324C28.647 32.5134 27.1434 32.8125 25.625 32.8125Z"
            fill="#1D8C64"
          />
        </svg>
      </div>
      <div class="ml-4">
        <p class="text-2xl font-semibold text-[#1D8C64]">
          {{ minutes }}:{{ seconds < 10 ? `0${seconds}` : seconds }}
        </p>
      </div>
    </div>
    <!-- số các số câu hỏi -->
    <div class="grid grid-cols-5 gap-1.5 my-4 mx-5">
      <div v-for="(answer, index) in countAnswer" :key="index">
        <div
          class="flex justify-center items-center w-[42px] h-[42px] border border-[#DADEF2] rounded-md"
          :style="{
            backgroundColor:
              checkAnswerPick[index] != null ? '#005FD0' : 'white',
          }"
        >
          <p
            :style="{
              color: checkAnswerPick[index] != null ? '#FFF' : '#141933',
            }"
          >
            {{ index + 1 }}
          </p>
        </div>
      </div>
    </div>
    <!-- ghi chú -->
    <div class="flex h-[70px] w-auto bg-[#FFFBF0]">
      <div class="ml-5 mt-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="21"
          height="20"
          viewBox="0 0 21 20"
          fill="none"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M8.83406 17.8847C9.34823 18.1821 9.92573 18.3313 10.5032 18.3313C11.0799 18.3313 11.6574 18.183 12.1724 17.8855L16.4899 15.388C17.5157 14.7947 18.1541 13.6888 18.1541 12.503V7.49965C18.1541 6.31465 17.5157 5.20882 16.4899 4.61465L12.1716 2.11715C11.1432 1.52215 9.86406 1.52215 8.83406 2.11715L4.51573 4.61465C3.4899 5.20798 2.85156 6.31382 2.85156 7.49965V12.503C2.85156 13.688 3.4899 14.7938 4.51573 15.388L8.83406 17.8847ZM10.5052 15.0005C10.0444 15.0005 9.67188 14.6272 9.67188 14.1672V9.88216C9.67188 9.42216 10.0444 9.04883 10.5052 9.04883C10.966 9.04883 11.3385 9.42216 11.3385 9.88216V14.1672C11.3385 14.6272 10.966 15.0005 10.5052 15.0005ZM9.67188 6.3457C9.67188 6.8057 10.0444 7.17904 10.5052 7.17904C10.966 7.17904 11.3385 6.8057 11.3385 6.3457V5.92904C11.3385 5.46904 10.966 5.0957 10.5052 5.0957C10.0444 5.0957 9.67188 5.46904 9.67188 5.92904V6.3457Z"
            fill="#F3A127"
          />
        </svg>
      </div>
      <div class="ml-3 text-start text-clip mr-4 mt-2">
        <p class="text-xs font-normal">
          Thời gian được tính từ lúc bắt đầu làm bài. Hết thời gian quy định hệ
          thống sẽ tự nộp bài.
        </p>
      </div>
    </div>
    <!-- nộp bài thi -->
    <div class="mt-4 mx-5 mb-6">
      <div class="">
        <button
          @click="submitButton()"
          class="h-10 w-full bg-[#005FD0] rounded-lg text-white"
        >
          Nộp bài thi
        </button>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, watch, onMounted } from "vue";
import { getTimeRedis, setTimeRedis } from "../../services/examService.js";
import { useUserStore } from "@/stores/UserStore";
import { useRouter } from "vue-router";
import axios from "axios";
export default {
  props: {
    exam_id: {
      type: [Number, String],
    },
    countAnswer: {
      type: Array,
    },
    checkAnswerPick: {
      type: Array,
    },
    submitButton: {
      type: Function,
    },
    timeExam: {
      type: [Number, String],
    },
  },
  setup(props) {
    const examId = ref(props.exam_id);
    const store = useUserStore();
    const user_id = store.user.user.id;
    const router = useRouter();
    const minutes = ref(0);
    const seconds = ref(0);
    const totalTime = ref(0);
    const answerSelect = ref(props.checkAnswerPick);
    const startCountdown = () => {
      const countdownInterval = setInterval(() => {
        //setInterval: Thực hiện lặp lại hàm bên trong sau 1 khoảng time nhất định
        if (totalTime.value > 0) {
          totalTime.value--;
          minutes.value = Math.floor(totalTime.value / 60);
          seconds.value = totalTime.value % 60;
        } else {
          clearInterval(countdownInterval);
          props.submitButton();
          router.push("/userExam");
          // Xử lý khi thời gian kết thúc
        }
      }, 1000); //sau mỗi 1000 mili giây
    };
    //lấy thời gian từ redis
    const saveTimeRedis = () => {
      try {
        const data = {
          userKey: user_id + "-" + examId.value,
          time: totalTime.value,
        };
        setTimeRedis(data);
        console.log("Save time to redis");
      } catch (error) {
        console.log("Error saving time to redis: ", error);
      }
    };
    const restoreTimeRedis = async () => {
      try {
        const data = {
          userKey: user_id + "-" + examId.value,
        };
        const response = await axios.post(
          "http://localhost:5000/api/exam/getTime",
          data
        );
        totalTime.value = response.data.time || props.timeExam * 60;
        minutes.value = Math.floor(totalTime.value / 60);
        seconds.value = totalTime.value % 60;
        startCountdown();
      } catch (error) {
        console.log("Error restoring time to redis: ", error);
      }
    };
    //được gọi khi component được gọi lần đầu tiên
    onMounted(() => {
      restoreTimeRedis();
    });
    watch(totalTime, () => {
      saveTimeRedis();
    });

    return {
      minutes,
      seconds,
      totalTime,
    };
  },
};
</script>
